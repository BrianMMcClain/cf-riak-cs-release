#!/bin/bash
set -e

<% if p("riak_cs.register_route") %>

cd /var/vcap/packages/acceptance-tests

export GOROOT=/var/vcap/packages/golang
export GOPATH=$PWD/vendor
export PATH=$GOROOT/bin:$GOPATH/bin:$PWD/bin:$PATH
export CONFIG=$PWD/integration_config.json

cat > integration_config.json <<EOF
{
  "api":                 "<%= p("cf.api_url") %>",
  "admin_user":          "<%= p("cf.admin_username") %>",
  "admin_password":      "<%= p("cf.admin_password") %>",
  "apps_domain":         "<%= p("cf.apps_domain") %>",
  "riak_cs_scheme" :     "<%= p("riak_cs.ssl_enabled")? "https://" : "http://" %>",
  "skip_ssl_validation": <%= p("riak_cs.skip_ssl_validation") %>
}
EOF

bin/test errand

<% else %>
echo "The route registration process is disabled because properties.riak_cs.register_route is set to false"
echo "This assumes no cloudfoundry instance is deployed alongside cf-riak-cs-release"
echo "Unable to run tests because they require the presence of a cloudfoundry instance"
<% end %>
