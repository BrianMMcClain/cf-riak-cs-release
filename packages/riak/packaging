#!/usr/bin/env bash

# - /var/vcap/packages/riak/rel/bin/riak

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables
set +x

RIAK_VERSION=1.2.0
export HOME=/var/vcap
export PATH=/var/vcap/packages/erlang/bin:$PATH

tar xzf riak/riak-${RIAK_VERSION}.tar.gz
cd riak-${RIAK_VERSION}

# riak-1.1.4 failed to contain leveldb
# https://github.com/basho/riak/issues/191
cd deps/eleveldb/c_src/
unzip ${BOSH_COMPILE_TARGET}/riak/leveldb-14478f17.zip
mv basho-leveldb-2aebdd9 leveldb

cd ${BOSH_COMPILE_TARGET}/riak-${RIAK_VERSION}
# make rel/riak
make rel

# output is in rel/riak
cp -prv rel/riak ${BOSH_INSTALL_TARGET}/rel